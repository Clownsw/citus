-- Negative test cases for citus_split_shard_by_split_points UDF.
CREATE SCHEMA citus_split_shard_by_split_points_negative;
SET search_path TO citus_split_shard_by_split_points_negative;
SET citus.shard_count TO 1;
SET citus.shard_replication_factor TO 1;
SET citus.next_shard_id TO 1;
CREATE TABLE table_to_split (id bigserial PRIMARY KEY, value char);
CREATE TABLE table_second (id bigserial PRIMARY KEY, value char);
-- Shard1     | -2147483648   | -1073741825
-- Shard2     | -1073741824   | -1
-- Shard3     | 0             | 1073741823
-- Shard4     | 1073741824    | 2147483647
SELECT create_distributed_table('table_to_split','id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

--SELECT create_distributed_table('table_second', 'id', colocate_with => 'table_to_split');
SELECT nodeid AS worker_1_node FROM pg_dist_node WHERE nodeport=:worker_1_port \gset
SELECT nodeid AS worker_2_node FROM pg_dist_node WHERE nodeport=:worker_2_port \gset
SELECT * FROM citus_shards;
   table_name   | shardid |                         shard_name                          | citus_table_type | colocation_id | nodename  | nodeport | shard_size
---------------------------------------------------------------------
 table_to_split |       1 | citus_split_shard_by_split_points_negative.table_to_split_1 | distributed      |       1390006 | localhost |     8888 |          0
 table_to_split |       1 | citus_split_shard_by_split_points_negative.table_to_split_1 | distributed      |       1390006 | localhost |     8887 |          0
 table_to_split |       1 | citus_split_shard_by_split_points_negative.table_to_split_1 | distributed      |       1390006 | localhost |     9995 |          0
 table_to_split |       1 | citus_split_shard_by_split_points_negative.table_to_split_1 | distributed      |       1390006 | localhost |     9992 |          0
 table_to_split |       1 | citus_split_shard_by_split_points_negative.table_to_split_1 | distributed      |       1390006 | localhost |    57637 |          0
 table_to_split |       1 | citus_split_shard_by_split_points_negative.table_to_split_1 | distributed      |       1390006 | localhost |     9998 |          0
 table_to_split |       1 | citus_split_shard_by_split_points_negative.table_to_split_1 | distributed      |       1390006 | localhost |     9997 |          0
(7 rows)

SELECT * FROM pg_dist_shard;
  logicalrelid  | shardid | shardstorage | shardminvalue | shardmaxvalue
---------------------------------------------------------------------
 table_to_split |       1 | t            | -2147483648   | 2147483647
(1 row)

--SET client_min_messages TO LOG;
--SET citus.log_remote_commands TO on;
CREATE OR REPLACE VIEW show_catalog AS SELECT n.nspname as "Schema",
  c.relname as "Name",
  pg_catalog.pg_get_userbyid(c.relowner) as "Owner"
FROM pg_catalog.pg_class c
     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE c.relkind IN ('r','p','')
      AND n.nspname <> 'pg_catalog'
      AND n.nspname !~ '^pg_toast'
      AND n.nspname <> 'information_schema'
  AND pg_catalog.pg_table_is_visible(c.oid)
ORDER BY 1,2;
-- UDF fails for range partitioned tables.
\c - - - :master_port
--SET citus.log_remote_commands TO on;
SET citus.next_shard_id TO 100;
SET search_path TO citus_split_shard_by_split_points_negative;
SELECT nodeid AS worker_1_node FROM pg_dist_node WHERE nodeport=:worker_1_port \gset
SELECT nodeid AS worker_2_node FROM pg_dist_node WHERE nodeport=:worker_2_port \gset
SELECT citus_split_shard_by_split_points(
	1,
	ARRAY['0'],
	ARRAY[:worker_1_node, :worker_2_node],
	'force_logical');
WARNING:  replication slot "citus_split_replicationslot_for_shard_1" does not exist
CONTEXT:  while executing command on localhost:xxxxx
WARNING:  connection claimed exclusively at transaction commit
WARNING:  connection claimed exclusively at transaction commit
WARNING:  connection claimed exclusively at transaction commit
WARNING:  connection claimed exclusively at transaction commit
 citus_split_shard_by_split_points
---------------------------------------------------------------------

(1 row)

INSERT INTO table_to_split values(100,'a');
INSERT INTO table_to_split values(400, 'a');
INSERT INTO table_to_split values(500, 'a');
\c - - - :worker_2_port
SET search_path TO citus_split_shard_by_split_points_negative;
SELECT * FROM show_catalog;
                   Schema                   |        Name        |  Owner
---------------------------------------------------------------------
 citus_split_shard_by_split_points_negative | table_to_split     | postgres
 citus_split_shard_by_split_points_negative | table_to_split_101 | postgres
(2 rows)

SELECT * FROM pg_subscription;
  oid  | subdbid |              subname              | subowner | subenabled | subbinary | substream |                                            subconninfo                                             |    subslotname    | subsynccommit |            subpublications
---------------------------------------------------------------------
 17311 |   16384 | citus_shard_split_subscription_10 |    17310 | t          | f         | f         | host='localhost' port=xxxxx user='postgres' dbname='regression' connect_timeout=20 sslmode=prefer  | citus_split_18_10 | off           | {citus_shard_split_publication_18_10}
(1 row)

SELECT slot_name FROM pg_replication_slots;
 slot_name
---------------------------------------------------------------------
(0 rows)

SELECT * FROM table_to_split_101;
 id  | value
---------------------------------------------------------------------
 100 | a
 500 | a
(2 rows)

\c - - - :worker_1_port
SET search_path TO citus_split_shard_by_split_points_negative;
SELECT * FROM show_catalog;
                   Schema                   |        Name        |  Owner
---------------------------------------------------------------------
 citus_split_shard_by_split_points_negative | table_to_split     | postgres
 citus_split_shard_by_split_points_negative | table_to_split_100 | postgres
(2 rows)

SELECT * FROM pg_publication;
  oid  |               pubname               | pubowner | puballtables | pubinsert | pubupdate | pubdelete | pubtruncate | pubviaroot
---------------------------------------------------------------------
 17371 | citus_shard_split_publication_16_10 |       10 | f            | t         | t         | t         | t           | f
 17374 | citus_shard_split_publication_18_10 |       10 | f            | t         | t         | t         | t           | f
(2 rows)

SELECT * FROM pg_subscription;
  oid  | subdbid |              subname              | subowner | subenabled | subbinary | substream |                                            subconninfo                                             |    subslotname    | subsynccommit |            subpublications
---------------------------------------------------------------------
 17378 |   16384 | citus_shard_split_subscription_10 |    17377 | t          | f         | f         | host='localhost' port=xxxxx user='postgres' dbname='regression' connect_timeout=20 sslmode=prefer  | citus_split_16_10 | off           | {citus_shard_split_publication_16_10}
(1 row)

SELECT slot_name FROM pg_replication_slots;
                slot_name
---------------------------------------------------------------------
 citus_split_replicationslot_for_shard_1
 citus_split_16_10
 citus_split_18_10
(3 rows)

SELECT * FROM table_to_split_100;
 id  | value
---------------------------------------------------------------------
 400 | a
(1 row)

